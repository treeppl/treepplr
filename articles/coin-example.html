<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Coin flipping • treepplr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Coin flipping">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">treepplr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.11.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/treepplr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/coin-example.html">Coin flipping</a></li>
    <li><a class="dropdown-item" href="../articles/crbd-example.html">Constant-rate Birth Death example</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/treeppl/treepplr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Coin flipping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/treeppl/treepplr/blob/main/vignettes/coin-example.Rmd" class="external-link"><code>vignettes/coin-example.Rmd</code></a></small>
      <div class="d-none name"><code>coin-example.Rmd</code></div>
    </div>

    
    
<p>This tutorial describes how to analyze a simple coin-flipping model
using <em>treepplr</em>.</p>
<p>We assume that the probability of obtaining heads with our coin is
<code>p</code>, and that we have a set of flips informing us about the
value of <code>p</code>.</p>
<p>In a Bayesian analysis of this problem, we need to specify a prior
probability distribution for the value of <code>p</code>. Here, we will
assume that <code>p</code> is drawn from a <code>Beta(2,2)</code>
distribution.</p>
<div class="section level2">
<h2 id="load-the-required-r-packages">Load the required R packages<a class="anchor" aria-label="anchor" href="#load-the-required-r-packages"></a>
</h2>
<p>First load the required R packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/treeppl/treepplr" class="external-link">treepplr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="understanding-the-coin-model">Understanding the coin model<a class="anchor" aria-label="anchor" href="#understanding-the-coin-model"></a>
</h2>
<p>The coin model is one of the most basic models in the TreePPL model
library. You can find all available models and some information about
them <a href="https://treeppl.org/docs/model-library" class="external-link">here</a>.</p>
<p>If you want to look at the TreePPL code here in R, you can use the
following functions:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tp_model.html">tp_model</a></span><span class="op">(</span><span class="st">"coin"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_file.html" class="external-link">read_file</a></span><span class="op">(</span><span class="va">model_path</span><span class="op">)</span></span></code></pre></div>
<p>The main part of the model is defined in a function called
<code>coinModel</code>:</p>
<pre><code>model function coinModel(coinflips: Bool[]) =&gt; Real  {
  // Uncomment if you want to test the input
  //printLn("Input:");
  //let coinStr = apply(bool2string, coinflips);
  //printLn(join(coinStr));
  assume p ~ Beta(2.0, 2.0); // prior
  let n = length(coinflips);
  for i in 1 to n {
    flip(coinflips[i], p); // likelihood
  }
  return(p); // posterior
}</code></pre>
<p>The definition of this function is preceded by the keywords
<code>model function</code>. All model scripts must have exactly one
model function.</p>
<p>The model function takes as input argument(s) the observed data that
we wish to condition on. In our case, the data are represented by a
sequence (vector or array) of Boolean
(<code>TRUE</code>/<code>FALSE</code>) values.</p>
<p>Note that TreePPL uses type annotation of input variables in the form
of <code>&lt;argument_name&gt;: &lt;data_type&gt;</code>. The square
brackets <code>[]</code> are used to denote a sequence type, that is,
<code>coinflips: Bool[]</code> tells us that the model function takes a
single argument by the name of <code>coinflips</code>, and the data type
is a sequence of Booleans.</p>
<p>The return type of a function is specified using the format
<code>=&gt; &lt;data_type&gt;</code>. Our model function returns the
value of <code>p</code>. In general, the model function should return
the model parameters for which we are interested in inferring the
posterior distribution.</p>
<p>The model function starts with a few statements that are commented
out by having <code>//</code> put in front of them. The code in these
lines can be used to print the value of the <code>coinflips</code>
argument.</p>
<p>The statement <code>assume p ~ Beta(2.0,2.0)</code> specifies the
prior probability distribution for the parameter <code>p</code> in our
model. TreePPL provides a number of built-in probability distributions;
they all have names starting with a capital letter, like the
<code>Beta</code> distribution used here.</p>
<p>The <code>assume</code> statement is followed by a loop over the
input data sequence, conditioning the simulation on each observed value
(heads/<code>TRUE</code> or tails/<code>FALSE</code>). Specifically,
this is achieved by calling the help function <code>flip</code>.</p>
<p>The <code>flip</code> function is defined as follows:</p>
<pre><code>function flip(datapoint: Bool, probability: Real) {
  observe datapoint ~ Bernoulli(probability);
}</code></pre>
<p><code>Bernoulli</code> is a probability distribution on a binary
outcome space, represented as a Boolean variable taking the values
<code>TRUE</code> or <code>FALSE</code>. This is the appropriate
probability distribution for coin flipping.</p>
<p>The single parameter of the <code>Bernoulli</code> distribution,
called <code>probability</code> in the <code>flip</code> function, is
assumed by convention to be the probability of obtaining the outcome
<code>TRUE</code>. In our case, this would be the probability of
obtaining heads.</p>
<p>The <code>observe</code> statement weights the simulation with the
likelihood of observing a particlar data point from the Bernoulli
distribution.</p>
<p>This completes the TreePPL description of the coin flipping model.
All TreePPL model descriptions essentially follow the same format. For a
more complete coverage of the TreePPL language, see the language
overview in the <a href="https://treeppl.org/docs/" class="external-link">TreePPL online
documentation</a>.</p>
</div>
<div class="section level2">
<h2 id="model-compilation-and-inference-strategy">Model compilation and inference strategy<a class="anchor" aria-label="anchor" href="#model-compilation-and-inference-strategy"></a>
</h2>
<p>TreePPL offers a variety of inference methods. Different methods work
best for different models. Here, we will use sequential Monte Carlo
(SMC), specifically the bootstrap particle filter version (the
<code>method=smc-bpf</code> option).</p>
<p>The function <code><a href="../reference/tp_compile.html">tp_compile()</a></code> has many optional arguments
that allow you to select among the inference methods supported by
TreePPL, and setting relevant options for each one of them. For an
up-to-date description of available inference strategies supported, see
<code><a href="../reference/tp_compile_options.html">tp_compile_options()</a></code>.</p>
<p>Now let’s compile the model to en executable that also contains the
necessary machinery to run the chosen inference method.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exe_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tp_compile.html">tp_compile</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"coin"</span>, method <span class="op">=</span> <span class="st">"smc-bpf"</span>, particles <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Now we can start analyzing the model by inferring the value of
<code>p</code> given some observed sequence of coin flips. To do this,
we need to provide the observations in a suitable format. To load the
example data provided in the <em>treepplr</em> package, use:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tp_data.html">tp_data</a></span><span class="op">(</span>data_input <span class="op">=</span> <span class="st">"coin"</span><span class="op">)</span></span></code></pre></div>
<p>We can look at the structure of the input data using:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<pre><code>$coinflips
 [1]  TRUE  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE FALSE FALSE  TRUE FALSE FALSE</code></pre>
<p>The TreePPL compiler requires data in JSON format. The conversion
from R variables to appropriate JSON code understood by TreePPL is done
automatically by <em>treepplr</em> for supported data types. For
instance, logical vectors in R are converted to sequences of Booleans
(<code>Bool[]</code>) in TreePPL.</p>
<p>In R, the data are collected in a list. Each element in the list is
named using the corresponding argument name expected by the TreePPL
model function. The arguments can be given in any order in the list. In
our case, the model function only takes one argument called
<code>coinflips</code>, so the R list only contains one element named
<code>coinflips</code>.</p>
</div>
<div class="section level2">
<h2 id="run-treeppl">Run TreePPL<a class="anchor" aria-label="anchor" href="#run-treeppl"></a>
</h2>
<p>Now we can run the TreePPL program, inferring the posterior
distribution of <code>p</code> conditioned on the input data. This is
done using the <code>tp_run</code> function.</p>
<p>Let’s run 10 sweeps (10 SMC runs, if you wish).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tp_run.html">tp_run</a></span><span class="op">(</span>compiled_model <span class="op">=</span> <span class="va">exe_path</span>, data <span class="op">=</span> <span class="va">data</span>, n_sweeps <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>The run should take a few seconds to complete depending on your
machine.</p>
<p>In general, the TreePPL inference strategies can be described as
nested approaches where the outermost shell defines the character of the
inference output. If the outer shell is SMC, as is the case here, the
returned object will be a nested R list. Each entry in the outermost
list layer will correspond to a sweep. Each sweep will contain three
values: the normalizing constant estimated in that sweep, each of the
returned values from the model function (one returned value for each SMC
particle), and the likelihood weight of each returned value (one weight
for each particle).</p>
</div>
<div class="section level2">
<h2 id="plot-the-posterior-distribution">Plot the posterior distribution<a class="anchor" aria-label="anchor" href="#plot-the-posterior-distribution"></a>
</h2>
<p>In SMC we can assess the quality of the inference by running several
sweeps and comparing their normalizing constants to test if they
generated similar estimates of the posterior distribution. A popular
argument from the SMC literature suggests that the SMC estimate is
accurate if the variance of the estimates of the normalizing constant
across sweeps is lower than 1.</p>
<p>To check the variance of the normalizing constant, use the
<code><a href="../reference/tp_smc_convergence.html">tp_smc_convergence()</a></code> function. But first, we’ll use the
<code><a href="../reference/tp_parse_smc.html">tp_parse_smc()</a></code> function to convert the results returned by
TreePPL into an R data frame of appropriately weighted values, taking
both the particle weights and normalizing constants (the sweep weights,
if you wish) into account. Note that both the particle weights and
normalizing constants are given in log units.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tp_parse_smc.html">tp_parse_smc</a></span><span class="op">(</span><span class="va">output_list</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/tp_smc_convergence.html">tp_smc_convergence</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.000693138</span></span></code></pre></div>
<p>It seems that our run provides a quite accurate estimate of the
posterior distribution, as the variance is much smaller than 1.0.</p>
<p>It is also easy to plot the sampled values.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">output</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">samples</span>, weight <span class="op">=</span> <span class="va">norm_weight</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 col <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span>, binwidth<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="coin-example_files/figure-html/unnamed-chunk-10-1.png" class="r-plt" alt="" width="480"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mariana P Braga.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

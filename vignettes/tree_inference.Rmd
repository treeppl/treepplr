---
title: "Tree inference"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{tree_inference}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)

options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
library(treepplr)
library(dplyr)
library(ggplot2)
library(ape)
```

## Load model and data files

Load the tree inference model and example data available within `treepplr`.

```{r}
model <- tp_model("tree_inference")
data <- tp_data("tree_inference")
```

The data in this example is a toy dataset ...

```{r}
str(data)
```

## Run TreePPL

Now we can compile and run the TreePPL program. The function `tp_treeppl()` has 
many optional arguments to change the inference method used. Here, we will use 

```{r, eval=FALSE}
output_list <- tp_treeppl(model = model, data = data, method = "smc-apf", 
                          samples = 1000, subsample = 5, resample = "manual", 
                          n_runs = 10)
```

```{r, echo=FALSE}
output_list <- readRDS("rdata/tree_inference/output_tree_inference.rds")
```

The result is a list of sweeps, each one containing 3 elements: the sampled 
parameter values and the weights (in log scale) for each of the 5 particles in 
each sweep, and the normalizing constant for the whole sweep.

```{r}
str(output_list,max.level = 2)
```

## Plot the posterior distribution

In this example we will check that the different runs converged to the same posterior,
by checking the variance in the normalizing constant among runs.

```{r, fig.height=5, fig.width=5}
tp_smc_convergence(output_list)
```

There are different ways to summarize the posterior distribution of trees. In
this examples, we calculate the the MAP (Maximum A Posteriori) tree. We do this 
by finding the single tree topology that has the highest posterior probability, 
and then using `ape::consensus` to compute average branch lengths for all sampled
trees with the MAP topology.

```{r, fig.height=4, fig.width=5}
out_trees <- tp_json_to_phylo(output_list)

map_tree <- tp_map_tree(out_trees)
plot(map_tree)
axisPhylo()
```

